
# PrometheusRule — Alert rules for Churn API

# Metrics referenced from serving/api/main.py:
#   churn_api_requests_total       (Counter, labels: endpoint, status)
#   churn_api_request_duration_seconds (Histogram, labels: endpoint)
#   churn_api_predictions_total    (Counter, labels: horizon)
#   churn_api_risk_tier_total      (Counter, labels: tier)
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: churn-api-alerts
  namespace: telco-churn
  labels:
    app: churn-api
    app.kubernetes.io/part-of: telco-churn
spec:
  groups:
    - name: churn-api.rules
      rules:
        #  Alert 1: API unreachable for >5 minutes ──
        - alert: ChurnAPIDown
          expr: up{job="churn-api-monitor"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Churn API is down"
            description: "Churn API has been unreachable for more than 5 minutes."

        #  Alert 2: Error rate exceeds 5% ──
        - alert: ChurnAPIHighErrorRate
          expr: |
            (
              sum(rate(churn_api_requests_total{status="error"}[5m]))
              /
              sum(rate(churn_api_requests_total[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Churn API error rate above 5%"
            description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes."

        #  Alert 3: P99 latency exceeds 2 seconds ──
        - alert: ChurnAPIHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(churn_api_request_duration_seconds_bucket[5m])) by (le)
            ) > 2.0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Churn API P99 latency above 2 seconds"
            description: "P99 latency is {{ $value }}s over the last 5 minutes."

        #  Alert 4: Pod restarting frequently ──
        - alert: ChurnAPIPodRestarts
          expr: |
            increase(kube_pod_container_status_restarts_total{
              namespace="telco-churn",
              container=~"churn-api|churn-dashboard"
            }[15m]) > 3
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "Churn pod restarting frequently"
            description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in 15 minutes."

        #  Alert 5: No predictions in 30 minutes (business hours) ──
        - alert: ChurnAPINoPredictions
          expr: |
            sum(increase(churn_api_predictions_total[30m])) == 0
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "No predictions made in 30 minutes"
            description: "The API has not served any predictions in the last 30 minutes."
